<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Dashboard</title>
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: #1a1a1a;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 27% 30% 40%;
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Add media query for mobile devices */
        @media screen and (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;  /* Stack elements vertically */
                gap: 20px;  /* Increase gap between stacked elements */
                padding: 10px;  /* Add some padding on mobile */
            }

            /* Adjust title size for mobile */
            .subtitle {
                font-size: 2rem;
            }

            /* Make board columns more readable on mobile */
            .board {
                grid-template-columns: 1fr;  /* Stack board columns vertically */
                gap: 15px;
            }

            /* Add some spacing between board sections */
            .column {
                margin-bottom: 15px;
            }

            /* Ensure task list is readable on mobile */
            .task-item {
                flex-wrap: wrap;  /* Allow items to wrap on narrow screens */
            }

            .task-name {
                width: 100%;  /* Full width on mobile */
                margin-bottom: 5px;
            }

            .checkboxes {
                width: 100%;
                justify-content: space-between;  /* Spread checkboxes evenly */
            }
        }

        /* Scheduler Styles */
        .scheduler {
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 15px;
        }

        .time-selectors {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .selector-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .selector-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        select {
            background-color: #3a3a3a;
            border: none;
            border-radius: 4px;
            color: white;
            padding: 8px;
            width: 100%;
            cursor: pointer;
        }

        .hours-display {
            padding: 8px;
            background-color: #3a3a3a;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 20px;
        }

        .time-block {
            display: flex;
            align-items: center;
            position: relative;
            border-radius: 4px;
            transition: all 0.3s ease;
            border: 1px solid #2a2a2a;
        }

        .time-block.split {
            gap: 4px;
            background: transparent !important;
        }

        .split-section {
            position: relative;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .split-section:first-child {
            width: 45%;
        }

        .split-section:last-child {
            width: 55%;
        }

        .time-input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            background: transparent;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        /* Scheduler Time Block Colors */
        .morning-early {
            background-color: #4a2639;
        }

        .day-mid {
            background-color: #2c4a3e;
        }

        .evening {
            background-color: #2c3e4a;
        }

        .night {
            background-color: #2b1f36;
        }

        .morning-early.active, .split-section.morning-early.active {
            background-color: #8a3960;
        }

        .day-mid.active, .split-section.day-mid.active {
            background-color: #3d8066;
        }

        .evening.active, .split-section.evening.active {
            background-color: #41718a;
        }

        .night.active, .split-section.night.active {
            background-color: #563c76;
        }

        .x-task {
            background-color: #1a1a1a !important;
        }

        .checkmark {
            position: absolute;
            right: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            z-index: 2;
        }

        /* Board Styles */
        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            height: 100%;
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 5px;

        }

        .column {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 0.2rem;
            min-width: 0; /* Allows text truncation */
        }

        .column h2 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .board .task {
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            border-radius: 4px;
            cursor: move;
            transition: background-color 0.5s ease;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .add-task {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            margin-top: 0.3rem;
            background-color: #1a1a1a;
            border-radius: 4px;
            cursor: pointer;
            height: 32px;
        }

        .add-task-input {
            display: none;
            width: 100%;
            background-color: transparent;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.9rem;
        }

        .add-task-input.active {
            display: block;
        }

        .add-task .plus-icon {
            font-size: 1.2rem;
            color: #666;
            text-align: center;
        }

        /* Board Column Colors */
        .one-thing .task {
            background-color: #6b2b5a;
        }

        .today .task {
            background-color: #2b5a3f;
        }

        .do-later .task {
            background-color: #8b5735;
        }

        /* Task List Styles */
        .task-list-container {
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 15px;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 6px;
            margin: 3px 0;
            background-color: #3a3a3a;
            border-radius: 4px;
            cursor: move;
            gap: 6px;
            font-size: 0.9rem;
            flex-wrap: wrap;  /* Allow wrapping */
            overflow: hidden;  /* Hide any overflow */
        }

        .task-name {
            flex: 0 0 80px;  /* Reduced width to prevent overflow */
            min-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .checkboxes {
            display: flex;
            gap: 8px;
            flex: 1;
            justify-content: flex-start;
            flex-wrap: wrap;  /* Allow checkboxes to wrap */
            min-width: 0;  /* Allow container to shrink */
        }

        .checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #666;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 0 0 18px;  /* Changed: fixed size with no grow/shrink */
        }

        .checkbox:checked {
            position: relative;
        }

        .checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 12px;
            left: 3px;
            top: 0px;
        }

        .drag-handle {
            padding: 0 5px;
            cursor: move;
            color: #666;
            margin-left: auto;  /* Push handle to the right */
        }

        .dragging {
            opacity: 0.5;
        }

        /* Add new title styles */
        .title-container {
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Roboto', sans-serif;
        }

        .main-title {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }

        .subtitle {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 2px;
        }

        /* Add new styles for the add habit button and input */
        .add-habit {
            display: flex;
            align-items: center;
            padding: 6px;
            margin: 3px 0;
            background-color: #1a1a1a;
            border-radius: 4px;
            cursor: pointer;
            gap: 6px;
            font-size: 0.9rem;
        }

        .add-habit-input {
            display: none;
            width: 100px;
            min-width: 100px;
            background-color: #1a1a1a;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.9rem;
        }

        .add-habit-input.active {
            display: block;
        }

        .add-habit .plus-icon {
            font-size: 1.2rem;
            color: #666;
            width: 100%;
            text-align: center;
        }

        /* Update mobile styles */
        @media screen and (max-width: 768px) {
            .task-item {
                gap: 8px;
            }

            .task-name {
                flex: 0 0 80px;  /* Keep consistent with desktop */
            }

            .checkboxes {
                flex: 1;
                justify-content: flex-start;
                gap: 8px;
                min-width: 0;  /* Allow container to shrink */
            }

            .drag-handle {
                margin-left: auto;  /* Push handle to the right */
            }
        }
    </style>
</head>
<body>
    <!-- Add new title section -->
    <div class="title-container">
        <h1 class="main-title">YATDA 2.0</h1>
        <div class="subtitle">C0UGHMAN's Sheet</div>
    </div>
    
    <div class="main-container">

        <!-- Scheduler Column -->
        <div class="scheduler">
            <div id="timeBlocks"></div>
        </div>


        <!-- Task List Column -->
        <div class="task-list-container">
            <ul class="task-list">
                <!-- Tasks will be generated by JavaScript -->
            </ul>
            <div class="add-habit">
                <span class="plus-icon">+</span>
                <input type="text" class="add-habit-input" placeholder="New habit">
            </div>
        </div>

        <!-- Board Column -->
        <div class="board">
            <div class="column one-thing">
                <h2>One Thing</h2>
                <div class="tasks">
                </div>
                <div class="add-task">
                    <span class="plus-icon">+</span>
                    <input type="text" class="add-task-input" placeholder="New task">
                </div>
            </div>

            <div class="column today">
                <h2>Today</h2>
                <div class="tasks">
                </div>
                <div class="add-task">
                    <span class="plus-icon">+</span>
                    <input type="text" class="add-task-input" placeholder="New task">
                </div>
            </div>

            <div class="column do-later">
                <h2>Do Later</h2>
                <div class="tasks">
                </div>
                <div class="add-task">
                    <span class="plus-icon">+</span>
                    <input type="text" class="add-task-input" placeholder="New task">
                </div>
            </div>
        </div>


    </div>

    

  <script>
// Initialize Firebase with your config
const firebaseConfig = {
    apiKey: "AIzaSyB5YyE7JS7sF1QeUO0r-rCnIANV5-_15Vk",
    authDomain: "yet-another-to-do-app-c29e5.firebaseapp.com",
    projectId: "yet-another-to-do-app-c29e5",
    storageBucket: "yet-another-to-do-app-c29e5.appspot.com",
    messagingSenderId: "641086458329",
    appId: "1:641086458329:web:4ccd75830ffb852d45f1c8",
    measurementId: "G-GYHY52H8VZ"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Track authentication state
let isAuthenticated = false;

// Main initialization
document.addEventListener('DOMContentLoaded', () => {
    // Initialize UI components first
    initializeScheduler();
    initializeBoard();
    initializeHabitList();
    initializeAddHabit();
    setupDoubleClickHandlers();

    // Handle authentication state changes
    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log('User is authenticated:', user.uid);
            isAuthenticated = true;
            
            // Only set up Firebase listeners after authentication
            setupFirebaseListeners();
            
            // Set up sync handlers
            syncSchedulerChanges();
            syncTaskChanges();
            syncHabitChanges();
        } else {
            console.log('User is not authenticated, attempting anonymous sign-in...');
            isAuthenticated = false;
            
            // Attempt anonymous sign-in
            auth.signInAnonymously()
                .catch((error) => {
                    console.error('Error signing in:', error);
                    // If anonymous auth fails, fall back to local storage
                    if (error.code === 'auth/admin-restricted-operation') {
                        console.log('Falling back to local storage...');
                        setupLocalStorageListeners();
                    }
                });
        }
    });
});

// Add fallback local storage functions
function setupLocalStorageListeners() {
    const chunksheet = JSON.parse(localStorage.getItem('chunksheet') || '{}');
    updateScheduler(chunksheet);

    const tasks = JSON.parse(localStorage.getItem('tasks') || '{"0":[],"1":[],"2":[]}');
    updateBoard(tasks);

    const habits = JSON.parse(localStorage.getItem('habits') || '[]');
    updateHabitList(habits);
}

// Modify your database operations to check authentication
function writeToDatabase(collection, data) {
    if (isAuthenticated) {
        return db.collection(collection).add(data);
    } else {
        // Fall back to localStorage
        const stored = JSON.parse(localStorage.getItem(collection) || '[]');
        stored.push(data);
        localStorage.setItem(collection, JSON.stringify(stored));
        return Promise.resolve({ id: Date.now().toString() });
    }
}

// Update your sync functions to use the new write function
function syncTaskChanges() {
    const addTaskDivs = document.querySelectorAll('.add-task');
    addTaskDivs.forEach((addTaskDiv, index) => {
        const input = addTaskDiv.querySelector('.add-task-input');
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                writeToDatabase('task', {
                    text: input.value.trim(),
                    when: index
                }).catch(error => {
                    console.error('Error adding task:', error);
                });
            }
        });
    });
}


function syncXTaskChange(input) {
    if (!input || !input.placeholder) return;
    
    const hourMatch = input.placeholder.match(/\d+/);
    if (!hourMatch) return;
    
    const hour = hourMatch[0];
    const key = `h${hour}${input.placeholder.includes('PM') ? 'pm' : 'am'}`;
    
    const value = input.value.trim().toLowerCase();
    if (value === 'x' || value.startsWith('x ')) {
        // Update Firebase with the X value
        db.collection('chunksheet').doc('chunksheet').update({
            [key]: 'x'
        }).catch(error => {
            console.error('Error updating X task:', error);
        });
    }
}


// =============== Scheduler Functions ===============
function createSplitSections(timeBlock, firstPart, secondPart) {
    const colorClass = timeBlock.className.match(/(morning-early|day-mid|evening|night)/)[0];
    const wasActive = timeBlock.classList.contains('active');
    
    timeBlock.innerHTML = '';
    timeBlock.classList.add('split');
    
    const section1 = document.createElement('div');
    section1.className = `split-section ${colorClass}`;
    const input1 = document.createElement('input');
    input1.type = 'text';
    input1.className = 'time-input';
    input1.value = firstPart.trim();
    section1.appendChild(input1);
    
    const section2 = document.createElement('div');
    section2.className = `split-section ${colorClass}`;
    const input2 = document.createElement('input');
    input2.type = 'text';
    input2.className = 'time-input';
    input2.value = secondPart.trim();
    const checkmark = document.createElement('span');
    checkmark.className = 'checkmark';
    checkmark.textContent = 'âœ“';
    section2.appendChild(input2);
    section2.appendChild(checkmark);
    
    timeBlock.appendChild(section1);
    timeBlock.appendChild(section2);

    if (wasActive) {
        section1.classList.add('active');
        section2.classList.add('active');
        input1.disabled = true;
        input2.disabled = true;
    }
    
    // Handle X tasks for both sections
    handleXTask(input1);
    handleXTask(input2);
    
    attachEventListeners(section1);
    attachEventListeners(section2);
    attachBackspaceHandler(input2, timeBlock);
    checkmark.addEventListener('click', () => handleSplitCheckmark(timeBlock));
}


function mergeSections(timeBlock) {
    const colorClass = timeBlock.className.match(/(morning-early|day-mid|evening|night)/)[0];
    const leftInput = timeBlock.querySelector('.split-section:first-child .time-input');
    const wasActive = leftInput.disabled;
    const leftValue = leftInput.value;

    timeBlock.innerHTML = '';
    timeBlock.classList.remove('split');
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'time-input';
    input.value = leftValue;
    
    const checkmark = document.createElement('span');
    checkmark.className = 'checkmark';
    checkmark.textContent = 'âœ“';
    
    timeBlock.appendChild(input);
    timeBlock.appendChild(checkmark);
    
    if (wasActive) {
        timeBlock.classList.add('active');
        input.disabled = true;
    }

    attachEventListeners(timeBlock);
    checkmark.addEventListener('click', handleRegularCheckmark);
    handleXTask(input);
}

function attachBackspaceHandler(input, timeBlock) {
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && this.value === '') {
            e.preventDefault();
            mergeSections(timeBlock);
        }
    });
}

function attachEventListeners(element) {
    const input = element.querySelector('.time-input');
    if (input) {
        input.addEventListener('input', function() {
            handleXTask(this);
            handleSplitTask(this);
            syncXTaskChange(this); // Add this line
        });

        input.addEventListener('focus', function() {
            if (!this.disabled) {
                this.select();
            }
        });
    }
}
function handleSplitTask(input) {
    const value = input.value;
    const timeBlock = input.closest('.time-block');
    
    if (!timeBlock.classList.contains('split') && value.includes(' / ')) {
        const [firstPart, secondPart] = value.split(' / ');
        createSplitSections(timeBlock, firstPart, secondPart);
    }
}

function handleXTask(input) {
    if (!input) return;
    const container = input.closest('.split-section') || input.parentElement;
    if (!container) return;
    
    const value = input.value.trim().toLowerCase();
    if (value === 'x' || value.startsWith('x ')) {
        container.classList.add('x-task');
        input.value = 'x'; // Ensure consistent x display
    } else {
        container.classList.remove('x-task');
    }
}

function handleSplitCheckmark(timeBlock) {
    const sections = timeBlock.querySelectorAll('.split-section');
    let canActivate = false;
    
    sections.forEach(section => {
        if (!section.classList.contains('x-task')) {
            canActivate = true;
        }
    });

    if (!canActivate) return;

    sections.forEach(section => {
        if (!section.classList.contains('x-task')) {
            section.classList.toggle('active');
            const input = section.querySelector('.time-input');
            if (section.classList.contains('active')) {
                if (!input.value) {
                    input.value = input.placeholder;
                }
                input.disabled = true;
            } else {
                input.disabled = false;
            }
        }
    });
}

function handleRegularCheckmark() {
    const timeBlock = this.closest('.time-block');
    if (timeBlock.querySelector('.x-task')) {
        return;
    }

    timeBlock.classList.toggle('active');
    const input = timeBlock.querySelector('.time-input');
    
    if (timeBlock.classList.contains('active')) {
        if (!input.value) {
            input.value = input.placeholder;
        }
        input.disabled = true;
    } else {
        input.disabled = false;
    }
}

function formatTime(hour) {
    if (hour === 0) return "12:00 AM";
    else if (hour < 12) return `${hour}:00 AM`;
    else if (hour === 12) return "12:00 PM";
    else return `${hour - 12}:00 PM`;
}

function getTimeBlockColor(hour) {
    if (hour >= 5 && hour <= 8) return 'morning-early';
    if (hour >= 9 && hour <= 14) return 'day-mid';
    if (hour >= 15 && hour <= 19) return 'evening';
    return 'night';
}

// Global variables for drag and drop
const columnColors = {
    'one-thing': '#6b2b5a',
    'today': '#2b5a3f',
    'do-later': '#8b5735'
};

let dragStartColor = null;

// Firebase-aware drag and drop setup
function setupDragAndDrop(element, type) {
    if (!element) return;

    // Remove existing listeners
    const newElement = element.cloneNode(true);
    element.parentNode?.replaceChild(newElement, element);
    
    // Add new drag listeners
    newElement.addEventListener('dragstart', (e) => {
        newElement.classList.add('dragging');
        if (type === 'task') {
            e.dataTransfer.setData('text/plain', newElement.textContent);
            dragStartColor = window.getComputedStyle(newElement).backgroundColor;
        }
    });

    newElement.addEventListener('dragend', (e) => {
        newElement.classList.remove('dragging');
        if (type === 'habit') {
            // Update habit order in Firebase
            const habitList = newElement.closest('.task-list');
            const habits = [...habitList.querySelectorAll('.task-item')];
            const habitOrder = habits.map(h => h.querySelector('.task-name').textContent);
            
            updateHabitOrderInFirebase(habitOrder);
        }
    });

    // Add double-click deletion
    newElement.addEventListener('dblclick', (e) => {
        if (type === 'task') {
            const columnIndex = getColumnIndex(newElement);
            if (typeof columnIndex === 'number') {
                deleteTaskFromFirebase(newElement.textContent, columnIndex);
                newElement.remove();
            }
        } else if (type === 'habit' && !e.target.classList.contains('checkbox')) {
            const habitName = newElement.querySelector('.task-name').textContent;
            deleteHabitFromFirebase(habitName);
            newElement.remove();
        }
    });

    return newElement;
}

function setupDropZones() {
    // Setup board columns
    const columns = document.querySelectorAll('.column');
    columns.forEach((column, columnIndex) => {
        column.addEventListener('dragover', e => {
            e.preventDefault();
            const draggingTask = document.querySelector('.board .task.dragging');
            if (!draggingTask) return;

            const tasksContainer = column.querySelector('.tasks');
            if (!tasksContainer) return;

            tasksContainer.appendChild(draggingTask);
            updateTaskColumnInFirebase(draggingTask.textContent, columnIndex);
            
            // Update task color
            const columnClass = column.classList[1];
            const targetColor = columnColors[columnClass];
            updateTaskColor(draggingTask, targetColor);
        });
    });

    // Setup habit list
    const habitList = document.querySelector('.task-list');
    if (habitList) {
        habitList.addEventListener('dragover', e => {
            e.preventDefault();
            const draggingItem = document.querySelector('.task-item.dragging');
            if (!draggingItem) return;

            const siblings = [...habitList.querySelectorAll('.task-item:not(.dragging)')];
            const nextSibling = findDropPosition(e.clientY, siblings);
            
            if (nextSibling) {
                habitList.insertBefore(draggingItem, nextSibling);
            } else {
                habitList.appendChild(draggingItem);
            }
        });
    }
}

// Firebase update functions
function updateTaskColumnInFirebase(taskText, columnIndex) {
    if (!isAuthenticated) return;

    db.collection('task')
        .where('text', '==', taskText)
        .get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                doc.ref.update({
                    when: columnIndex
                }).catch(error => {
                    console.error('Error updating task position:', error);
                });
            });
        })
        .catch(error => {
            console.error('Error finding task to update:', error);
        });
}


function updateHabitOrderInFirebase(habitOrder) {
    if (!isAuthenticated) return;

    const batch = db.batch();
    
    db.collection('habit').get()
        .then(snapshot => {
            const habitDocs = new Map();
            snapshot.forEach(doc => {
                habitDocs.set(doc.data().name, doc.ref);
            });
            
            habitOrder.forEach((habitName, index) => {
                const habitRef = habitDocs.get(habitName);
                if (habitRef) {
                    batch.update(habitRef, { order: index });
                }
            });
            
            return batch.commit();
        })
        .catch(error => {
            console.error('Error updating habit order:', error);
        });
}

function deleteTaskFromFirebase(taskText, columnIndex) {
    if (!isAuthenticated) return;

    db.collection('task')
        .where('text', '==', taskText)
        .where('when', '==', columnIndex)
        .get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                doc.ref.delete().catch(error => {
                    console.error('Error deleting task:', error);
                });
            });
        })
        .catch(error => {
            console.error('Error finding task to delete:', error);
        });
}

function deleteHabitFromFirebase(habitName) {
    if (!isAuthenticated) return;

    db.collection('habit')
        .where('name', '==', habitName)
        .get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                doc.ref.delete().catch(error => {
                    console.error('Error deleting habit:', error);
                });
            });
        })
        .catch(error => {
            console.error('Error finding habit to delete:', error);
        });
}

// Helper functions
function getColumnIndex(taskElement) {
    const column = taskElement.closest('.column');
    if (!column) return null;
    return column.classList.contains('one-thing') ? 0 :
           column.classList.contains('today') ? 1 : 2;
}

function updateTaskColor(taskElement, targetColor) {
    if (dragStartColor) {
        taskElement.style.transition = 'none';
        taskElement.style.backgroundColor = dragStartColor;
        taskElement.offsetHeight; // Force reflow
        taskElement.style.transition = 'background-color 0.5s ease';
        taskElement.style.backgroundColor = targetColor;
    }
}

function findDropPosition(mouseY, siblings) {
    return siblings.find(sibling => {
        const box = sibling.getBoundingClientRect();
        return mouseY < box.top + box.height / 2;
    });
}

// Initialize drag and drop
function initializeDragAndDrop() {
    // Setup all draggable elements
    document.querySelectorAll('.board .task').forEach(task => {
        setupDragAndDrop(task, 'task');
    });
    
    document.querySelectorAll('.task-item').forEach(habit => {
        setupDragAndDrop(habit, 'habit');
    });
    
    // Setup drop zones
    setupDropZones();
}

// Update Firebase listeners to reinitialize drag and drop
function setupFirebaseListeners() {
    // Existing task listener
    db.collection('task').onSnapshot(snapshot => {
        const tasks = { 0: [], 1: [], 2: [] };
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data && typeof data.when === 'number' && data.when >= 0 && data.when <= 2) {
                tasks[data.when].push(data.text);
            }
        });
        updateBoard(tasks);
        // Reinitialize drag and drop after updating board
        initializeDragAndDrop();
    }, error => {
        console.error("Task listener error:", error);
    });

    // Existing habit listener
    db.collection('habit')
        .orderBy('order')
        .onSnapshot(snapshot => {
            const habits = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data && data.name) {
                    habits.push({
                        id: doc.id,
                        name: data.name,
                        monday: data.monday || false,
                        tuesday: data.tuesday || false,
                        wednesday: data.wednesday || false,
                        thursday: data.thursday || false,
                        friday: data.friday || false,
                        saturday: data.saturday || false,
                        sunday: data.sunday || false,
                        order: data.order || 0
                    });
                }
            });
            // Sort habits by order before updating
            habits.sort((a, b) => a.order - b.order);
            updateHabitList(habits);
            // Reinitialize drag and drop after updating habits
            initializeDragAndDrop();
        }, error => {
            console.error("Habit listener error:", error);
        });
}

// Update initializeBoard to use the global setupDragAndDrop
function initializeBoard() {
    const tasks = document.querySelectorAll('.board .task');
    const columns = document.querySelectorAll('.column');
    const addTaskDivs = document.querySelectorAll('.add-task');

    // Add new task functionality
    addTaskDivs.forEach((addTaskDiv, columnIndex) => {
        const plusIcon = addTaskDiv.querySelector('.plus-icon');
        const input = addTaskDiv.querySelector('.add-task-input');

        addTaskDiv.addEventListener('click', (e) => {
            if (e.target === addTaskDiv || e.target === plusIcon) {
                input.classList.add('active');
                plusIcon.style.display = 'none';
                input.focus();
            }
        });

        input.addEventListener('blur', () => {
            input.classList.remove('active');
            plusIcon.style.display = 'block';
            input.value = '';
        });

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                if (isAuthenticated) {
                    db.collection('task').add({
                        text: input.value.trim(),
                        when: columnIndex
                    }).catch(error => {
                        console.error('Error adding task:', error);
                    });
                }
                
                input.value = '';
                input.classList.remove('active');
                plusIcon.style.display = 'block';
            }
        });
    });

    // Setup existing tasks
    tasks.forEach(task => {
        setupTaskDragAndDrop(task);
    });

    // Setup column drop zones
    columns.forEach((column, columnIndex) => {
        column.addEventListener('dragover', e => {
            e.preventDefault();
            const draggingTask = document.querySelector('.board .task.dragging');
            if (draggingTask) {
                const tasksContainer = column.querySelector('.tasks');
                if (tasksContainer) {
                    tasksContainer.appendChild(draggingTask);
                    
                    // Update task position in database
                    if (isAuthenticated) {
                        db.collection('task')
                            .where('text', '==', draggingTask.textContent)
                            .get()
                            .then(querySnapshot => {
                                querySnapshot.forEach(doc => {
                                    doc.ref.update({
                                        when: columnIndex
                                    }).catch(error => {
                                        console.error('Error updating task position:', error);
                                    });
                                });
                            })
                            .catch(error => {
                                console.error('Error finding task to update:', error);
                            });
                    }
                }
            }
        });
    });
}

function setupTaskDragAndDrop(task) {
    if (!task) return;

    task.draggable = true;
    
    task.addEventListener('dragstart', (e) => {
        task.classList.add('dragging');
        e.dataTransfer.setData('text/plain', task.textContent);
        dragStartColor = window.getComputedStyle(task).backgroundColor;
    });

    task.addEventListener('dragend', (e) => {
        task.classList.remove('dragging');
        
        // Update task position in Firebase
        const columnIndex = getColumnIndex(task);
        if (isAuthenticated && columnIndex !== null) {
            db.collection('task')
                .where('text', '==', task.textContent)
                .get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        doc.ref.update({
                            when: columnIndex
                        }).catch(error => {
                            console.error('Error updating task position:', error);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error finding task to update:', error);
                });
        }
    });
}

// =============== Habit Functions ===============
function setupHabitDragAndDrop(habit) {
    if (!habit) return;

    habit.draggable = true;
    
    habit.querySelectorAll('.checkbox').forEach(checkbox => {
        checkbox.addEventListener('mousedown', (e) => {
            e.stopPropagation();
        });
    });
    
    habit.addEventListener('dragstart', (e) => {
        habit.classList.add('dragging');
        habit.style.opacity = '0.5';
    });

    habit.addEventListener('dragend', async () => {
        habit.classList.remove('dragging');
        habit.style.opacity = '1';
        
        if (isAuthenticated) {
            try {
                const habitList = habit.closest('.task-list');
                const habits = [...habitList.querySelectorAll('.task-item')];
                
                // Create a batch for all updates
                const batch = db.batch();
                
                // Get all habit documents first
                const snapshot = await db.collection('habit').get();
                const habitDocs = new Map();
                snapshot.forEach(doc => {
                    habitDocs.set(doc.data().name, doc);
                });
                
                // Update each habit's order
                const updates = habits.map((habitElement, index) => {
                    const habitName = habitElement.querySelector('.task-name').textContent;
                    const doc = habitDocs.get(habitName);
                    if (doc) {
                        batch.update(doc.ref, { order: index * 1000 }); // Use larger numbers to allow for future reordering
                    }
                });
                
                // Commit all updates
                await batch.commit();
                
            } catch (error) {
                console.error('Error updating habit order:', error);
                // Optionally refresh the list to ensure consistency
                setupFirebaseListeners();
            }
        }
    });
}

function getRandomColor() {
    const hue = Math.floor(Math.random() * 360);
    return `hsl(${hue}, 70%, 40%)`;
}

      
function createHabitElement(habitData) {
    const li = document.createElement('li');
    li.className = 'task-item';
    li.draggable = true;
    
    // Create array of weekdays in order
    const weekdays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    
    // Generate checkboxes HTML with states from database
    const checkboxesHtml = weekdays.map(day => {
        const isChecked = habitData[day] ? 'checked' : '';
        return `<input type="checkbox" class="checkbox" data-day="${day}" ${isChecked}>`;
    }).join('');
    
    li.innerHTML = `
        <span class="task-name">${habitData.name}</span>
        <div class="checkboxes">
            ${checkboxesHtml}
        </div>
        <span class="drag-handle">â‰¡</span>
    `;

    // Add styling to checked boxes
    li.querySelectorAll('.checkbox').forEach(checkbox => {
        if (checkbox.checked) {
            const color = getRandomColor();
            checkbox.style.backgroundColor = color;
            checkbox.style.borderColor = color;
        }

        checkbox.addEventListener('change', function() {
            const day = this.dataset.day;
            if (this.checked) {
                const color = getRandomColor();
                this.style.backgroundColor = color;
                this.style.borderColor = color;
                
                // Update Firebase
                updateHabitCheckbox(habitData.name, day, true);
            } else {
                this.style.backgroundColor = '';
                this.style.borderColor = '#666';
                
                // Update Firebase
                updateHabitCheckbox(habitData.name, day, false);
            }
        });
    });

    setupHabitDragAndDrop(li);
    return li;
}

function updateHabitCheckbox(habitName, day, checked) {
    if (isAuthenticated) {
        db.collection('habit')
            .where('name', '==', habitName)
            .get()
            .then(querySnapshot => {
                querySnapshot.forEach(doc => {
                    doc.ref.update({
                        [day]: checked
                    }).catch(error => {
                        console.error('Error updating habit checkbox:', error);
                    });
                });
            })
            .catch(error => {
                console.error('Error finding habit to update:', error);
            });
    }
}

function updateHabitList(habits) {
    const habitList = document.querySelector('.task-list');
    habitList.innerHTML = '';
    habits.forEach(habit => {
        const habitElement = createHabitElement(habit);
        habitList.appendChild(habitElement);
    });
}

// =============== Initialize Scheduler ===============
function initializeScheduler() {
    const timeBlocksContainer = document.getElementById('timeBlocks');
    timeBlocksContainer.innerHTML = '';
    
    for (let hour = 0; hour < 24; hour++) {
        const timeBlock = document.createElement('div');
        timeBlock.className = `time-block ${getTimeBlockColor(hour)}`;
        
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'time-input';
        input.placeholder = formatTime(hour);
        
        const checkmark = document.createElement('span');
        checkmark.className = 'checkmark';
        checkmark.textContent = 'âœ“';
        
        timeBlock.appendChild(input);
        timeBlock.appendChild(checkmark);
        
        attachEventListeners(timeBlock);
        checkmark.addEventListener('click', handleRegularCheckmark);
        
        timeBlocksContainer.appendChild(timeBlock);
    }
}

// =============== Add Habit Functions ===============
function initializeAddHabit() {
    const addHabitDiv = document.querySelector('.add-habit');
    const plusIcon = addHabitDiv.querySelector('.plus-icon');
    const input = addHabitDiv.querySelector('.add-habit-input');

    // Handle clicking the add habit button
    addHabitDiv.addEventListener('click', (e) => {
        if (e.target === addHabitDiv || e.target === plusIcon) {
            input.classList.add('active');
            plusIcon.style.display = 'none';
            input.focus();
        }
    });

    // Handle input blur (clicking away)
    input.addEventListener('blur', () => {
        input.classList.remove('active');
        plusIcon.style.display = 'block';
        input.value = '';
    });

    // Handle Enter key press
    input.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
            if (isAuthenticated) {
                try {
                    // Get the current highest order
                    const snapshot = await db.collection('habit').get();
                    const currentHighestOrder = snapshot.docs.reduce((max, doc) => {
                        const order = doc.data().order || 0;
                        return order > max ? order : max;
                    }, -1);

                    // Add new habit with order = highest + 1
                    await db.collection('habit').add({
                        name: input.value.trim(),
                        monday: false,
                        tuesday: false,
                        wednesday: false,
                        thursday: false,
                        friday: false,
                        saturday: false,
                        sunday: false,
                        order: currentHighestOrder + 1
                    });
                } catch (error) {
                    console.error('Error adding habit:', error);
                }
            }
            
            input.value = '';
            input.classList.remove('active');
            plusIcon.style.display = 'block';
        }
    });
}

function setupDoubleClickHandlers() {
    // For scheduler time blocks
    const timeBlocks = document.querySelectorAll('.time-block');
    timeBlocks.forEach(block => {
        block.querySelector('.time-input').addEventListener('dblclick', (e) => {
            e.stopPropagation();
            e.target.value = '';
            if (block.classList.contains('split')) {
                mergeSections(block);
            }
            block.classList.remove('active');
            block.classList.remove('x-task');
            e.target.disabled = false;
        });
    });

    // For task list items
    const taskItems = document.querySelectorAll('.task-item');
    taskItems.forEach(item => {
        item.addEventListener('dblclick', (e) => {
            if (!e.target.classList.contains('checkbox')) {
                const habitName = item.querySelector('.task-name').textContent;
                if (isAuthenticated) {
                    deleteHabit(habitName);
                } else {
                    const habits = JSON.parse(localStorage.getItem('habits') || '[]');
                    const filteredHabits = habits.filter(habit => habit.name !== habitName);
                    localStorage.setItem('habits', JSON.stringify(filteredHabits));
                    updateHabitList(filteredHabits.map(h => h.name));
                }
                item.remove();
            }
        });
    });

    // For board tasks
    const boardTasks = document.querySelectorAll('.board .task');
    boardTasks.forEach(task => {
        task.addEventListener('dblclick', (e) => {
            const columnIndex = task.closest('.column').classList.contains('one-thing') ? 0 :
                              task.closest('.column').classList.contains('today') ? 1 : 2;
            if (isAuthenticated) {
                deleteTask(task.textContent, columnIndex);
            } else {
                const tasks = JSON.parse(localStorage.getItem('tasks') || '{"0":[],"1":[],"2":[]}');
                tasks[columnIndex] = tasks[columnIndex].filter(t => t !== task.textContent);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                updateBoard(tasks);
            }
            task.remove();
        });
    });
}

      
// =============== Firebase Operations ===============
function setupFirebaseListeners() {
    db.collection('chunksheet').doc('chunksheet')
        .onSnapshot(doc => {
            if (doc.exists) {
                updateScheduler(doc.data());
            }
        }, error => {
            console.error("Chunksheet listener error:", error);
        });

    db.collection('task')
        .onSnapshot(snapshot => {
            const tasks = { 0: [], 1: [], 2: [] };
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data && typeof data.when === 'number' && data.when >= 0 && data.when <= 2) {
                    tasks[data.when].push(data.text);
                }
            });
            updateBoard(tasks);
        }, error => {
            console.error("Task listener error:", error);
        });

    db.collection('habit')
        .onSnapshot(snapshot => {
            const habits = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data && data.name) {
                    habits.push({
                        id: doc.id,
                        name: data.name,
                        monday: data.monday || false,
                        tuesday: data.tuesday || false,
                        wednesday: data.wednesday || false,
                        thursday: data.thursday || false,
                        friday: data.friday || false,
                        saturday: data.saturday || false,
                        sunday: data.sunday || false,
                        order: data.order || 0
                    });
                }
            });
            // Sort habits by order before updating
            habits.sort((a, b) => a.order - b.order);
            updateHabitList(habits);
        }, error => {
            console.error("Habit listener error:", error);
        });
}

function updateScheduler(data) {
    if (!data) return;
    const timeBlocks = document.querySelectorAll('.time-block');
    
    timeBlocks.forEach(block => {
        const input = block.querySelector('.time-input');
        if (!input || !input.placeholder) return;
        
        const hourMatch = input.placeholder.match(/\d+/);
        if (!hourMatch) return;
        
        const hour = hourMatch[0];
        const key = `h${hour}${input.placeholder.includes('PM') ? 'pm' : 'am'}`;
        
        if (data[key]) {
            // Set the value first
            input.value = data[key];
            
            if (data[key].includes(' / ')) {
                // Handle split tasks
                const [firstPart, secondPart] = data[key].split(' / ');
                createSplitSections(block, firstPart, secondPart);
                
                // Apply X task styling to split sections if needed
                const sections = block.querySelectorAll('.split-section');
                sections.forEach(section => {
                    const sectionInput = section.querySelector('.time-input');
                    if (sectionInput) {
                        handleXTask(sectionInput);
                    }
                });
            } else {
                // Handle regular tasks
                handleXTask(input);
            }
        }
    });
}


function updateBoard(tasks) {
    const columns = document.querySelectorAll('.column');
    columns.forEach((column, index) => {
        const tasksContainer = column.querySelector('.tasks');
        tasksContainer.innerHTML = '';
        if (tasks[index]) {
            tasks[index].forEach(taskText => {
                const task = document.createElement('div');
                task.className = 'task';
                task.draggable = true;
                task.textContent = taskText;
                setupTaskDragAndDrop(task);
                tasksContainer.appendChild(task);
            });
        }
    });
    setupDoubleClickHandlers();
}

function deleteTask(taskText, columnIndex) {
    db.collection('task')
        .where('text', '==', taskText)
        .where('when', '==', columnIndex)
        .get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                doc.ref.delete().catch(error => {
                    console.error('Error deleting task:', error);
                });
            });
        })
        .catch(error => {
            console.error('Error finding task to delete:', error);
        });
}

function deleteHabit(habitName) {
    db.collection('habit')
        .where('name', '==', habitName)
        .get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                doc.ref.delete().catch(error => {
                    console.error('Error deleting habit:', error);
                });
            });
        })
        .catch(error => {
            console.error('Error finding habit to delete:', error);
        });
}

// =============== Firebase Sync Functions ===============
function syncSchedulerChanges() {
    const timeBlocks = document.querySelectorAll('.time-block');
    timeBlocks.forEach(block => {
        const input = block.querySelector('.time-input');
        input.addEventListener('change', () => {
            try {
                const hour = input.placeholder.match(/\d+/)[0];
                const key = `h${hour}${input.placeholder.includes('PM') ? 'pm' : 'am'}`;
                db.collection('chunksheet').doc('chunksheet').update({
                    [key]: input.value
                }).catch(error => {
                    console.error('Error updating scheduler:', error);
                });
            } catch (error) {
                console.error('Error in scheduler sync:', error);
            }
        });
    });
}

function syncHabitChanges() {
    const addHabitDiv = document.querySelector('.add-habit');
    const input = addHabitDiv.querySelector('.add-habit-input');
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
            db.collection('habit').add({
                name: input.value.trim(),
                monday: false,
                tuesday: false,
                wednesday: false,
                thursday: false,
                friday: false,
                saturday: false,
                sunday: false
            }).catch(error => {
                console.error('Error adding habit:', error);
            });
        }
    });
}

// =============== Main Initialization ===============
document.addEventListener('DOMContentLoaded', () => {
    // Sign in anonymously first
    auth.signInAnonymously()
        .then(() => {
            console.log('Signed in anonymously');
            
            // Initialize all components
            initializeScheduler();
            initializeBoard();
            initializeHabitList();
            initializeAddHabit();
            setupDoubleClickHandlers();
            
            // Initialize drag and drop
            initializeDragAndDrop();
            
            // Set up Firebase listeners
            setupFirebaseListeners();
            
            // Set up sync handlers
            syncSchedulerChanges();
            syncTaskChanges();
            syncHabitChanges();
        })
        .catch((error) => {
            console.error('Error signing in:', error);
        });
});

function initializeHabitList() {
    const habitList = document.querySelector('.task-list');
    if (!habitList) return;
    
    // Clear existing content
    habitList.innerHTML = '';
    
    // Set up drag and drop functionality for the habit list
    habitList.addEventListener('dragover', e => {
        e.preventDefault();
        const draggingItem = document.querySelector('.task-item.dragging');
        if (draggingItem) {
            const siblings = [...habitList.querySelectorAll('.task-item:not(.dragging)')];
            const nextSibling = siblings.find(sibling => {
                const box = sibling.getBoundingClientRect();
                return e.clientY < box.top + box.height / 2;
            });

            if (nextSibling) {
                habitList.insertBefore(draggingItem, nextSibling);
            } else {
                habitList.appendChild(draggingItem);
            }
        }
    });

    // Load initial habits from Firebase if authenticated
    if (isAuthenticated) {
        db.collection('habit').get()
            .then(snapshot => {
                const habits = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data && data.name) {
                        habits.push({
                            name: data.name,
                            monday: data.monday || false,
                            tuesday: data.tuesday || false,
                            wednesday: data.wednesday || false,
                            thursday: data.thursday || false,
                            friday: data.friday || false,
                            saturday: data.saturday || false,
                            sunday: data.sunday || false
                        });
                    }
                });
                updateHabitList(habits);
            })
            .catch(error => {
                console.error("Error loading initial habits:", error);
            });
    }
}

// Add new setupColumnDragHandlers function
function setupColumnDragHandlers(columns) {
    columns.forEach((column, columnIndex) => {
        column.addEventListener('dragover', e => {
            e.preventDefault();
            const draggingTask = document.querySelector('.board .task.dragging');
            if (draggingTask) {
                const tasksContainer = column.querySelector('.tasks');
                if (tasksContainer) {
                    tasksContainer.appendChild(draggingTask);
                    
                    // Update task position in Firebase
                    if (isAuthenticated) {
                        db.collection('task')
                            .where('text', '==', draggingTask.textContent)
                            .get()
                            .then(querySnapshot => {
                                querySnapshot.forEach(doc => {
                                    doc.ref.update({
                                        when: columnIndex
                                    }).catch(error => {
                                        console.error('Error updating task position:', error);
                                    });
                                });
                            })
                            .catch(error => {
                                console.error('Error finding task to update:', error);
                            });
                    }

                    // Update task color
                    const columnClass = column.classList[1];
                    const targetColor = columnColors[columnClass];
                    
                    if (dragStartColor) {
                        draggingTask.style.transition = 'none';
                        draggingTask.style.backgroundColor = dragStartColor;
                        draggingTask.offsetHeight; // Force reflow
                        draggingTask.style.transition = 'background-color 0.5s ease';
                        draggingTask.style.backgroundColor = targetColor;
                    }
                }
            }
        });
    });
}

// Add new setupHabitListContainer function
function setupHabitListContainer() {
    const habitList = document.querySelector('.task-list');
    if (!habitList) return;

    habitList.addEventListener('dragover', (e) => {
        e.preventDefault();
        const draggingHabit = document.querySelector('.task-item.dragging');
        if (!draggingHabit) return;

        const afterElement = getDragAfterElement(habitList, e.clientY);
        const currentElement = draggingHabit;

        if (afterElement === null) {
            habitList.appendChild(currentElement);
        } else {
            habitList.insertBefore(currentElement, afterElement);
        }
    });

    habitList.addEventListener('drop', (e) => {
        e.preventDefault();
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Add new initializeDragAndDrop function
function initializeDragAndDrop() {
    // Initialize board drag and drop
    const tasks = document.querySelectorAll('.board .task');
    const columns = document.querySelectorAll('.column');
    
    tasks.forEach(task => setupTaskDragAndDrop(task));
    setupColumnDragHandlers(columns);

    // Initialize habit list drag and drop
    const habitList = document.querySelector('.task-list');
    const habits = document.querySelectorAll('.task-item');
    
    habits.forEach(habit => setupHabitDragAndDrop(habit));
    setupHabitListContainer();
}

</script>
    
</body>
</html>






